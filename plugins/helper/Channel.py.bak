import asyncio
from pyrogram import Client, filters
from pyrogram.types import InlineKeyboardButton, InlineKeyboardMarkup

# Store user input temporarily
user_data = {}

@Client.on_message(filters.command("button") & filters.reply)
async def ask_button_info(client, message):
    user_id = message.from_user.id
    replied_message = message.reply_to_message

    if not replied_message:
        await message.reply("Please reply to a message (text or media) to add a button.")
        return

    # Save chat and message ID to apply the button later
    user_data[user_id] = {
        "chat_id": message.chat.id,
        "message_id": replied_message.id
    }

    await message.reply("Send the **button name and URL** like:\n\n`Watch Now - https://example.com`")

@Client.on_message(filters.private & filters.text)
async def add_button(client, message):
    user_id = message.from_user.id

    if user_id in user_data:
        try:
            name, url = message.text.split(" - ", 1)

            chat_id = user_data[user_id]["chat_id"]
            msg_id = user_data[user_id]["message_id"]

            button = InlineKeyboardMarkup(
                [[InlineKeyboardButton(name.strip(), url=url.strip())]]
            )

            await client.edit_message_reply_markup(
                chat_id=chat_id,
                message_id=msg_id,
                reply_markup=button
            )

            await message.reply("Button added successfully!")
            del user_data[user_id]

        except Exception as e:
            await message.reply("Invalid format! Please send like:\n`Button Name - https://link.com`")

# Optional: Add a default button to every media in a channel
CHANNEL_IDS = [-1002453024937, -1001959922658, -1002470391435]

@Client.on_message(filters.channel & filters.media)
async def auto_add_button(client, message):
    if message.chat.id in CHANNEL_IDS:
        try:
            button = InlineKeyboardMarkup(
                [[InlineKeyboardButton("🍿 Movie Update Channel 🍿", url="https://t.me/+QVmLP_hlHNw3M2I1")]]
            )
            await message.edit_reply_markup(reply_markup=button)
        except Exception as e:
            print("Failed to auto-add button:", e)
